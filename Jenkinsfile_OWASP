pipeline {
    agent any

    tools {
        maven 'maven3'
        jdk 'jdk21'
    }

    environment {
        // JAVA HOME
        JAVA_HOME = tool name: 'jdk21', type: 'jdk'
        PATH = "${JAVA_HOME}/bin:${PATH}"
    
        // Tools and integrations
        SCANNER_HOME = tool 'SonarScanner'
        SONARQUBE = credentials('sonar-token')

        // OWASP API KEY
        NVD_API_KEY = credentials('nvd-api-key')

        // AWS ECR configuration
        AWS_REGION = 'us-east-1'
        AWS_ACCOUNT_ID = '822654906952'
        ECR_REPO_URL = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        ECR_APP_NAME = 'secureshop'
        IMAGE_REPO = "${ECR_REPO_URL}/${ECR_APP_NAME}"
        IMAGE_TAG = "${BUILD_NUMBER}"

        // Application name
        APP_NAME = 'SecureShop'
    }

    stages {

        stage('Git Checkout') {
    steps {
        checkout([$class: 'GitSCM',
            branches: [[name: 'main']],
            userRemoteConfigs: [[
                url: 'https://github.com/sudhancicd/secure-shop-devsecops.git',
                credentialsId: 'github-ssh-key'
            ]]
        ])
    }
}


        stage('Compile Source Code') {
            steps {
                echo 'ðŸ”§ Compiling Source code...'
                sh 'mvn compile'
            }
        }

        stage('Unit Test') {
            steps {
                echo 'ðŸ§ª Running Unit Tests...'
                sh 'mvn test -DskipTests=true'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'ðŸ§© Running SonarQube Code Analysis...'
                script {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            ${SCANNER_HOME}/bin/sonar-scanner \
                                -Dsonar.projectKey=SecureShop \
                                -Dsonar.projectName=SecureShop \
                                -Dsonar.projectVersion=${BUILD_NUMBER} \
                                -Dsonar.sources=src \
                                -Dsonar.java.binaries=target/classes \
                                -Dsonar.sourceEncoding=UTF-8 \
                                -Dsonar.host.url=http://98.84.135.194:9000 \
                                -Dsonar.login=$SONARQUBE
                        '''
                    }
                }
            }
        }
		        stage('OWASP Dependency Check') {
        			steps {
        				script {
        					echo 'ðŸ” Running OWASP Dependency Check without S3...'
        					dependencyCheck additionalArguments: """--scan . --format XML --out dependency-check-report --nvdApiKey $NVD_API_KEY --data /var/jenkins/.dependency-check-data/${env.BUILD_NUMBER}""",
        						odcInstallation: 'DC'
        
        					archiveArtifacts artifacts: '**/dependency-check-report/*', allowEmptyArchive: true
        					dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
        				}
        			}
        		}

                stage('Build Source Code') {
                    steps {
                        echo 'âš™ï¸ Packaging Source Code...'
                        sh 'mvn package -DskipTests=true'
                    }
                }

        stage('Artifact storing in Nexus') {
            steps {
                echo 'ðŸ“¦ Publishing Artifact to Nexus Repository...'
                script {
                    withMaven(
                        globalMavenSettingsConfig: 'global-maven-settings',
                        jdk: 'jdk21',
                        maven: 'maven3',
                        traceability: true
                    ) {
                        sh 'mvn clean deploy -DskipTests=true'
                    }
                }
            }
        }

        stage('Build Container Image & Push to ECR') {
            steps {
                script {
                    // Set IMAGE_TAG inside script block using Jenkins BUILD_NUMBER
                    IMAGE_TAG = "${BUILD_NUMBER ?: 'latest'}"
                    echo "Building Docker image: ${IMAGE_REPO}:${IMAGE_TAG}"

                    withAWS(region: "${AWS_REGION}", credentials: 'aws-creds') {
                        sh """
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO_URL}
                            docker build -t ${ECR_APP_NAME}:${IMAGE_TAG} .
                            docker tag ${ECR_APP_NAME}:${IMAGE_TAG} ${IMAGE_REPO}:${IMAGE_TAG}
                            docker push ${IMAGE_REPO}:${IMAGE_TAG}
                            docker image ls | grep ${ECR_APP_NAME}
                        """
                    }
                }
            }
        }

        stage('Trivy Image Scan') {
            steps {
                script {
                    echo 'ðŸ” Scanning Docker image with Trivy...'
                    sh """
                        trivy image --exit-code 0 --severity HIGH,CRITICAL ${IMAGE_REPO}:${IMAGE_TAG} > trivy-report.txt
                        trivy image --exit-code 1 --severity CRITICAL ${IMAGE_REPO}:${IMAGE_TAG} >> trivy-report.txt || true
                    """
                    archiveArtifacts artifacts: 'trivy-report.txt', allowEmptyArchive: true
                    echo 'âœ… Trivy scan completed and report archived.'
                }
            }
        }

stage('K8S Deploy') {
    steps {
        script {
            // Set environment variables for deployment
            def appName = 'secureshop'
            def awsRegion = 'us-east-1'
            def awsAccount = '822654906952'
            def imageRepo = "${awsAccount}.dkr.ecr.${awsRegion}.amazonaws.com/${appName}"
            def imageTag = "${BUILD_NUMBER ?: 'latest'}"

                // Export variables for envsubst
                sh """
                    export APP_NAME=${appName}
                    export IMAGE_REPO=${imageRepo}
                    export IMAGE_TAG=${imageTag}

                    # Delete old resources
                    kubectl delete deployment secureshop -n secureapp --ignore-not-found
                    kubectl delete deployment secure-shop -n secureapp --ignore-not-found
                    kubectl delete svc secureshop-service -n secureapp --ignore-not-found
                    kubectl delete svc secure-shop-service -n secureapp --ignore-not-found

                    # Generate processed YAML files
                    envsubst < kubernetes/deployment.yaml > /var/lib/jenkins/deployment-processed.yaml
                    envsubst < kubernetes/service.yaml > /var/lib/jenkins/service-processed.yaml
                
                    # Apply to Kubernetes
                    kubectl apply -f /var/lib/jenkins/deployment-processed.yaml
                    kubectl apply -f /var/lib/jenkins/service-processed.yaml

                    # Wait for rollout to finish
                    kubectl rollout status deployment/secureshop -n secureapp --timeout=120s
                    kubectl get svc -n secureapp
                """
            }
        }
    }


        stage('Commit Version Update') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'github-ssh-token', variable: 'GITHUB_TOKEN')]) { // Replace with the ID of the GitHub token credentials
                        sh 'git config user.email "sudhan@ci-cd.org"'
                        sh 'git config user.name "sudhancicd"'
						
						// Replace with the URL of your Git repository
                        sh "git remote set-url origin https://$GITHUB_TOKEN:x-oauth-basic@github.com/sudhancicd/secure-shop-devsecops.git" 
						
						//Clean workspace before rebase
						sh 'git reset --hard'
						sh 'git clean -fd'
						sh 'git fetch origin main'
                        sh 'git pull --rebase origin main'
                        sh 'git add .'
                        sh 'git commit -m "ci: version bump [skip ci]" || echo "No changes to commit"'
                        sh 'git push origin HEAD:main'
						sh 'git config user.email "sudhan@ci-cd.org"'


                    }
                }
            }
        }
    }
}
